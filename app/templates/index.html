{% extends "bootstrap/base.html" %}
{% block title %}Home{% endblock %}

{% block navbar %}
    <nav class="navbar navbar-light bg-light">
        <a class="navbar-brand" href="#">
            Dublin Bike Station
            {#                <img src="{{url_for('.static', filename='')}}" width="100" height="100" class="d-inline-block align-top" alt="">#}
        </a>
    </nav>
{% endblock navbar %}

{% block content %}
    <div id="bike_map" style="width:70%;height:600px;"></div>
    <div id="weather_box">{{ weather_json["weather"][0]["main"] }}-{{ weather_json["main"]["temp"] }}</div>
    <script>
        function myMap() {
            let mapProp = {
                center: new google.maps.LatLng(53.3471, -6.26059),
                zoom: 13,
            };

            var map = new google.maps.Map(document.getElementById('bike_map'), mapProp);

            var xhttp = new XMLHttpRequest();
            xhttp.onreadystatechange = function () {
                if (this.readyState == 4 && this.status == 200) {

                    response_json = JSON.parse(this.responseText);
                    for (let i = 0; i < response_json.length; i++) {
                        let image = {};
                        image.origin = new google.maps.Point(0, 0);
                        image.scaledSize = new google.maps.Size(30, 30);
                        if (response_json[i].available_bikes > 5 && response_json[i].status == "OPEN") {
                            image.url = 'static/img/green.png';
                        } else if (response_json[i].available_bikes > 0 && response_json[i].status == "OPEN") {
                            image.url = 'static/img/orange.png';
                        } else if (response_json[i].available_bikes == 0 && response_json[i].status == "OPEN") {
                            image.url = 'static/img/red.png';
                        } else {
                            image.url = 'static/img/grey.png';
                        }

                        let content = "<div>";
                        var marker = new google.maps.Marker({
                            position: {lat: response_json[i].position.lat, lng: response_json[i].position.lng},
                            map: map,
                            icon: image,
                            title: String(response_json[i].number)
                        });
                        content += "<h4>Station: " + response_json[i].name + "</h4>";
                        content += "<p>Available bike stands: " + response_json[i].available_bike_stands + "<br>";
                        content += "Available bikes: " + response_json[i].available_bikes + "<br></p>";
                        content += "</div>";
                        show_info(marker, content);
                    }
                }
            };
            xhttp.open("GET", "https://api.jcdecaux.com/vls/v1/stations?contract=Dublin&apiKey={{ bike_api_key }}", true);
            xhttp.send();
        }

        function show_info(marker, content) {
            var infowindow = new google.maps.InfoWindow({
                content: content,
                maxWidth: 500
            });
            marker.addListener("click", function () {
                infowindow.open(marker.get("map"), marker);
            });
        }
    </script>
    <script async defer
            src= {{ map_key }}>
    </script>
    <script type=text/javascript src="{{ url_for('static', filename='js/jquery-3.3.1.min.js') }}"></script>
{% endblock %}

